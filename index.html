<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç•ªèŒ„å›¾ç‰‡æ··æ·†å¤„ç†å·¥å…· - ä¿®å¤ç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #180161, #4f1787, #eb3678);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
        }
        
        .description {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.95);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .main-content {
            padding: 35px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            border: 3px dashed #4f1787;
            text-align: center;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #eb3678;
            background: #f0f7ff;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: #4f1787;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            display: inline-block;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(79, 23, 135, 0.4);
        }
        
        .upload-btn:hover {
            background: #3c1269;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(79, 23, 135, 0.6);
        }
        
        .process-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .process-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            min-width: 200px;
        }
        
        .encrypt-btn {
            background: #4f1787;
            color: white;
        }
        
        .encrypt-btn:hover {
            background: #3c1269;
            transform: translateY(-3px);
        }
        
        .decrypt-btn {
            background: #eb3678;
            color: white;
        }
        
        .decrypt-btn:hover {
            background: #d42a67;
            transform: translateY(-3px);
        }
        
        .download-btn {
            background: #fb773c;
            color: white;
        }
        
        .download-btn:hover {
            background: #e5672b;
            transform: translateY(-3px);
        }
        
        .process-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .progress-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #180161;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .progress-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f1787, #eb3678);
            border-radius: 15px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            font-weight: bold;
            color: #180161;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .image-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .image-preview {
            width: 100%;
            height: 150px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #ddd;
        }
        
        .image-name {
            font-weight: bold;
            color: #180161;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }
        
        .image-status {
            font-size: 0.9rem;
            color: #666;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #4f1787;
        }
        
        .info-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #180161;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .info-list {
            list-style-type: none;
            padding: 15px 0;
        }
        
        .info-list li {
            padding: 12px 0;
            border-bottom: 1px dashed #ccc;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .info-list li:last-child {
            border-bottom: none;
        }
        
        .info-list li::before {
            content: 'âœ“';
            color: #4f1787;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            background: #180161;
            color: white;
        }
        
        .settings-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .settings-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #180161;
            text-align: center;
        }
        
        .settings-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        
        .setting-item {
            flex: 1;
            min-width: 200px;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #180161;
        }
        
        .setting-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .debug-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
            font-family: monospace;
            font-size: 0.9rem;
            overflow: auto;
            max-height: 200px;
        }
        
        @media (max-width: 768px) {
            .process-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .process-btn {
                width: 100%;
                max-width: 300px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .main-content {
                padding: 25px;
            }
            
            .settings-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å°ç•ªèŒ„å›¾ç‰‡æ··æ·†å¤„ç†å·¥å…· - ä¿®å¤ç‰ˆ</h1>
            <p class="description">ä¿®å¤äº†å›¾ç‰‡æŸåé—®é¢˜ï¼Œä¼˜åŒ–äº†å¸Œå°”ä¼¯ç‰¹æ›²çº¿ç®—æ³•</p>
        </header>
        
        <div class="main-content">
            <div class="upload-section">
                <h2>ä¸Šä¼ å¤šå¼ å›¾ç‰‡è¿›è¡Œæ‰¹é‡å¤„ç†</h2>
                <p>æ”¯æŒJPG, PNG, BMP, WEBPç­‰å¸¸è§å›¾ç‰‡æ ¼å¼</p>
                <label for="fileInput" class="upload-btn">
                    ğŸ“ é€‰æ‹©å¤šå¼ å›¾ç‰‡
                </label>
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <p id="selectedFiles">æœªé€‰æ‹©æ–‡ä»¶</p>
            </div>
            
            <div class="settings-panel">
                <div class="settings-title">å¤„ç†è®¾ç½®</div>
                <div class="settings-group">
                    <div class="setting-item">
                        <label class="setting-label">æœ€å¤§åŒæ—¶å¤„ç†æ•°</label>
                        <select id="concurrentProcesses" class="setting-input">
                            <option value="1">1å¼ ï¼ˆæœ€ç¨³å®šï¼‰</option>
                            <option value="2">2å¼ </option>
                            <option value="3" selected>3å¼ ï¼ˆæ¨èï¼‰</option>
                            <option value="5">5å¼ </option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">å¤„ç†è´¨é‡</label>
                        <select id="qualitySetting" class="setting-input">
                            <option value="0.7">è¾ƒä½è´¨é‡ï¼ˆ0.7ï¼‰</option>
                            <option value="0.8">ä¸­ç­‰è´¨é‡ï¼ˆ0.8ï¼‰</option>
                            <option value="0.9" selected>é«˜è´¨é‡ï¼ˆ0.9ï¼‰</option>
                            <option value="0.95">åŸç½‘ç«™è´¨é‡ï¼ˆ0.95ï¼‰</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">è°ƒè¯•æ¨¡å¼</label>
                        <select id="debugMode" class="setting-input">
                            <option value="off">å…³é—­</option>
                            <option value="on">å¼€å¯</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="process-buttons">
                <button id="encryptBtn" class="process-btn encrypt-btn" disabled>æ‰¹é‡æ··æ·†å›¾ç‰‡</button>
                <button id="decryptBtn" class="process-btn decrypt-btn" disabled>æ‰¹é‡è§£æ··æ·†å›¾ç‰‡</button>
                <button id="downloadBtn" class="process-btn download-btn" disabled>ä¸‹è½½æ‰€æœ‰å›¾ç‰‡</button>
            </div>
            
            <div class="progress-container">
                <div class="progress-title">å¤„ç†è¿›åº¦</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0 / 0 å·²å®Œæˆ</div>
            </div>
            
            <div id="debugContainer" style="display: none;">
                <div class="settings-title">è°ƒè¯•ä¿¡æ¯</div>
                <div class="debug-info" id="debugInfo"></div>
            </div>
            
            <div class="image-grid" id="imageGrid">
                <!-- å›¾ç‰‡é¢„è§ˆå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="info-box">
                <div class="info-title">ä¿®å¤è¯´æ˜ä¸åŠŸèƒ½</div>
                <ul class="info-list">
                    <li>ä¿®å¤äº†å¸Œå°”ä¼¯ç‰¹æ›²çº¿ç®—æ³•ä¸­çš„åƒç´ æ˜ å°„é”™è¯¯</li>
                    <li>ä¼˜åŒ–äº†å›¾ç‰‡å¤„ç†æµç¨‹ï¼Œé¿å…åƒç´ æ•°æ®æŸå</li>
                    <li>æ·»åŠ äº†è°ƒè¯•æ¨¡å¼ï¼Œå¯æŸ¥çœ‹å¤„ç†è¿‡ç¨‹ä¸­çš„è¯¦ç»†ä¿¡æ¯</li>
                    <li>æ”¹è¿›äº†å†…å­˜ç®¡ç†ï¼Œé¿å…å¤„ç†å¤§å›¾ç‰‡æ—¶å´©æºƒ</li>
                    <li>æ”¯æŒæ‰¹é‡å¤„ç†ä»»æ„æ•°é‡çš„å›¾ç‰‡</li>
                    <li>ä¿æŒä¸åŸç½‘ç«™ç›¸åŒçš„ç®—æ³•å’Œè¾“å‡ºè´¨é‡</li>
                </ul>
                <p>ä½¿ç”¨è¯´æ˜ï¼šä¸Šä¼ å›¾ç‰‡åï¼Œæ ¹æ®éœ€è¦è°ƒæ•´å¤„ç†è®¾ç½®ï¼Œç„¶åé€‰æ‹©"æ‰¹é‡æ··æ·†å›¾ç‰‡"æˆ–"æ‰¹é‡è§£æ··æ·†å›¾ç‰‡"ï¼Œå¤„ç†å®Œæˆåå¯ä»¥æŸ¥çœ‹æ¯å¼ å›¾ç‰‡çš„æ•ˆæœï¼Œæœ€åç‚¹å‡»"ä¸‹è½½æ‰€æœ‰å›¾ç‰‡"ä¿å­˜ç»“æœã€‚</p>
            </div>
        </div>
        
        <footer>
            <p>Â© 2023 å°ç•ªèŒ„å›¾ç‰‡æ··æ·†æ‰¹é‡å¤„ç†å·¥å…· - ä¿®å¤ç‰ˆ | åŸºäºå¸Œå°”ä¼¯ç‰¹æ›²çº¿ç®—æ³•</p>
        </footer>
    </div>

    <script>
        // ä¿®å¤ç‰ˆå¸Œå°”ä¼¯ç‰¹æ›²çº¿ç”Ÿæˆå‡½æ•°
        function gilbert2d(width, height) {
            if (width <= 0 || height <= 0) return [];
            
            const coordinates = [];
            
            // ä½¿ç”¨è¿­ä»£æ–¹æ³•æ›¿ä»£é€’å½’ï¼Œé¿å…å †æ ˆæº¢å‡º
            const stack = [];
            stack.push({x: 0, y: 0, ax: width, ay: 0, bx: 0, by: height});
            
            while (stack.length > 0) {
                const {x, y, ax, ay, bx, by} = stack.pop();
                
                const w = Math.abs(ax + ay);
                const h = Math.abs(bx + by);
                
                const dax = Math.sign(ax), day = Math.sign(ay);
                const dbx = Math.sign(bx), dby = Math.sign(by);
                
                if (h === 1) {
                    // è¡Œå¡«å……
                    for (let i = 0; i < w; i++) {
                        coordinates.push([x + i * dax, y + i * day]);
                    }
                    continue;
                }
                
                if (w === 1) {
                    // åˆ—å¡«å……
                    for (let i = 0; i < h; i++) {
                        coordinates.push([x + i * dbx, y + i * dby]);
                    }
                    continue;
                }
                
                let ax2 = Math.floor(ax / 2), ay2 = Math.floor(ay / 2);
                let bx2 = Math.floor(bx / 2), by2 = Math.floor(by / 2);
                
                const w2 = Math.abs(ax2 + ay2);
                const h2 = Math.abs(bx2 + by2);
                
                if (2 * w > 3 * h) {
                    if ((w2 % 2) && (w > 2)) {
                        ax2 += dax;
                        ay2 += day;
                    }
                    
                    // é•¿æƒ…å†µï¼šåˆ†æˆä¸¤éƒ¨åˆ†
                    stack.push({x: x + ax2, y: y + ay2, ax: ax - ax2, ay: ay - ay2, bx, by});
                    stack.push({x, y, ax: ax2, ay: ay2, bx, by});
                } else {
                    if ((h2 % 2) && (h > 2)) {
                        bx2 += dbx;
                        by2 += dby;
                    }
                    
                    // æ ‡å‡†æƒ…å†µï¼šä¸€æ­¥ä¸Šï¼Œä¸€æ­¥é•¿æ°´å¹³ï¼Œä¸€æ­¥ä¸‹
                    stack.push({
                        x: x + (ax - dax) + (bx2 - dbx), 
                        y: y + (ay - day) + (by2 - dby),
                        ax: -bx2, ay: -by2, 
                        bx: -(ax - ax2), by: -(ay - ay2)
                    });
                    stack.push({x: x + bx2, y: y + by2, ax, ay, bx: bx - bx2, by: by - by2});
                    stack.push({x, y, ax: bx2, ay: by2, bx: ax2, by: ay2});
                }
            }
            
            return coordinates;
        }
        
        // éªŒè¯å¸Œå°”ä¼¯ç‰¹æ›²çº¿
        function validateGilbertCurve(curve, width, height) {
            if (curve.length !== width * height) {
                console.warn(`å¸Œå°”ä¼¯ç‰¹æ›²çº¿ç‚¹æ•°ä¸åŒ¹é…: æœŸæœ› ${width * height}, å®é™… ${curve.length}`);
                return false;
            }
            
            // æ£€æŸ¥æ‰€æœ‰ç‚¹æ˜¯å¦åœ¨å›¾åƒèŒƒå›´å†…
            for (const [x, y] of curve) {
                if (x < 0 || x >= width || y < 0 || y >= height) {
                    console.warn(`å¸Œå°”ä¼¯ç‰¹æ›²çº¿ç‚¹è¶…å‡ºèŒƒå›´: [${x}, ${y}]`);
                    return false;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤ç‚¹
            const pointSet = new Set();
            for (const [x, y] of curve) {
                const key = `${x},${y}`;
                if (pointSet.has(key)) {
                    console.warn(`å¸Œå°”ä¼¯ç‰¹æ›²çº¿æœ‰é‡å¤ç‚¹: [${x}, ${y}]`);
                    return false;
                }
                pointSet.add(key);
            }
            
            return true;
        }
        
        // å›¾ç‰‡å¤„ç†å‡½æ•°
        function processImage(img, mode, quality, debug = false) {
            return new Promise((resolve, reject) => {
                try {
                    const startTime = performance.now();
                    const width = img.width;
                    const height = img.height;
                    
                    if (debug) {
                        addDebugInfo(`å¼€å§‹å¤„ç†å›¾ç‰‡: ${width}x${height}, æ¨¡å¼: ${mode}`);
                    }
                    
                    const canvas = document.createElement("canvas");
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    const imgData = ctx.getImageData(0, 0, width, height);
                    const imgData2 = new ImageData(width, height);
                    
                    // ç”Ÿæˆå¸Œå°”ä¼¯ç‰¹æ›²çº¿
                    const curveStart = performance.now();
                    const curve = gilbert2d(width, height);
                    const curveTime = performance.now() - curveStart;
                    
                    if (debug) {
                        addDebugInfo(`ç”Ÿæˆå¸Œå°”ä¼¯ç‰¹æ›²çº¿: ${curve.length} ç‚¹, è€—æ—¶: ${curveTime.toFixed(2)}ms`);
                    }
                    
                    // éªŒè¯æ›²çº¿
                    if (!validateGilbertCurve(curve, width, height)) {
                        if (debug) {
                            addDebugInfo("å¸Œå°”ä¼¯ç‰¹æ›²çº¿éªŒè¯å¤±è´¥ï¼Œä½¿ç”¨è¡Œæ‰«æ");
                        }
                        // ä½¿ç”¨ç®€å•çš„è¡Œæ‰«æä½œä¸ºåå¤‡
                        for (let y = 0; y < height; y++) {
                            for (let x = 0; x < width; x++) {
                                curve[y * width + x] = [x, y];
                            }
                        }
                    }
                    
                    const offset = Math.round((Math.sqrt(5) - 1) / 2 * width * height) % (width * height);
                    
                    if (debug) {
                        addDebugInfo(`ä½¿ç”¨åç§»é‡: ${offset}`);
                    }
                    
                    // å¤„ç†åƒç´ 
                    const processStart = performance.now();
                    const data = imgData.data;
                    const newData = imgData2.data;
                    
                    if (mode === 'encrypt') {
                        // åŠ å¯†ï¼šå°†åŸå›¾å½“å‰ä½ç½®çš„åƒç´ æ”¾åˆ°æ–°å›¾çš„åç§»ä½ç½®
                        for (let i = 0; i < width * height; i++) {
                            const oldPos = curve[i];
                            const newPos = curve[(i + offset) % (width * height)];
                            
                            const oldIndex = (oldPos[1] * width + oldPos[0]) * 4;
                            const newIndex = (newPos[1] * width + newPos[0]) * 4;
                            
                            newData[newIndex] = data[oldIndex];
                            newData[newIndex + 1] = data[oldIndex + 1];
                            newData[newIndex + 2] = data[oldIndex + 2];
                            newData[newIndex + 3] = data[oldIndex + 3];
                        }
                    } else {
                        // è§£å¯†ï¼šå°†åŠ å¯†å›¾åç§»ä½ç½®çš„åƒç´ æ”¾å›åŸå›¾çš„ä½ç½®
                        for (let i = 0; i < width * height; i++) {
                            const oldPos = curve[i];
                            const newPos = curve[(i + offset) % (width * height)];
                            
                            const oldIndex = (oldPos[1] * width + oldPos[0]) * 4;
                            const newIndex = (newPos[1] * width + newPos[0]) * 4;
                            
                            newData[oldIndex] = data[newIndex];
                            newData[oldIndex + 1] = data[newIndex + 1];
                            newData[oldIndex + 2] = data[newIndex + 2];
                            newData[oldIndex + 3] = data[newIndex + 3];
                        }
                    }
                    
                    const processTime = performance.now() - processStart;
                    
                    if (debug) {
                        addDebugInfo(`åƒç´ å¤„ç†å®Œæˆ, è€—æ—¶: ${processTime.toFixed(2)}ms`);
                    }
                    
                    ctx.putImageData(imgData2, 0, 0);
                    
                    canvas.toBlob(blob => {
                        const totalTime = performance.now() - startTime;
                        if (debug) {
                            addDebugInfo(`å›¾ç‰‡å¤„ç†å®Œæˆ, æ€»è€—æ—¶: ${totalTime.toFixed(2)}ms`);
                        }
                        resolve(URL.createObjectURL(blob));
                    }, "image/jpeg", quality);
                    
                } catch (error) {
                    console.error("å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™:", error);
                    if (debug) {
                        addDebugInfo(`å¤„ç†å‡ºé”™: ${error.message}`);
                    }
                    reject(error);
                }
            });
        }
        
        // DOMå…ƒç´ å¼•ç”¨
        const fileInput = document.getElementById('fileInput');
        const encryptBtn = document.getElementById('encryptBtn');
        const decryptBtn = document.getElementById('decryptBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const selectedFiles = document.getElementById('selectedFiles');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const imageGrid = document.getElementById('imageGrid');
        const concurrentProcesses = document.getElementById('concurrentProcesses');
        const qualitySetting = document.getElementById('qualitySetting');
        const debugMode = document.getElementById('debugMode');
        const debugContainer = document.getElementById('debugContainer');
        const debugInfo = document.getElementById('debugInfo');
        
        // å­˜å‚¨ä¸Šä¼ çš„å›¾ç‰‡å’Œå¤„ç†ç»“æœ
        let uploadedImages = [];
        let processedImages = [];
        let currentlyProcessing = 0;
        let maxConcurrent = 3;
        
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        function addDebugInfo(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] ${message}<br>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                selectedFiles.textContent = `å·²é€‰æ‹© ${e.target.files.length} ä¸ªæ–‡ä»¶`;
                encryptBtn.disabled = false;
                decryptBtn.disabled = false;
                
                // æ¸…ç©ºä¹‹å‰çš„å›¾ç‰‡
                uploadedImages = [];
                processedImages = [];
                imageGrid.innerHTML = '';
                
                // æ˜¾ç¤º/éšè—è°ƒè¯•é¢æ¿
                debugContainer.style.display = debugMode.value === 'on' ? 'block' : 'none';
                if (debugMode.value === 'on') {
                    debugInfo.innerHTML = '';
                    addDebugInfo(`å·²é€‰æ‹© ${e.target.files.length} ä¸ªæ–‡ä»¶`);
                }
                
                // å¤„ç†æ¯ä¸ªæ–‡ä»¶
                Array.from(e.target.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            uploadedImages.push({
                                index: index,
                                name: file.name,
                                originalUrl: URL.createObjectURL(file),
                                image: img,
                                width: img.width,
                                height: img.height,
                                status: 'waiting'
                            });
                            
                            // æ·»åŠ åˆ°é¢„è§ˆç½‘æ ¼
                            const imageItem = document.createElement('div');
                            imageItem.className = 'image-item';
                            imageItem.innerHTML = `
                                <img class="image-preview" src="${URL.createObjectURL(file)}" alt="${file.name}">
                                <div class="image-name">${file.name}</div>
                                <div class="image-status" data-index="${index}">ç­‰å¾…å¤„ç†</div>
                            `;
                            imageGrid.appendChild(imageItem);
                            
                            if (debugMode.value === 'on') {
                                addDebugInfo(`åŠ è½½å›¾ç‰‡: ${file.name}, å°ºå¯¸: ${img.width}x${img.height}`);
                            }
                        };
                        img.onerror = function() {
                            console.error(`åŠ è½½å›¾ç‰‡å¤±è´¥: ${file.name}`);
                            if (debugMode.value === 'on') {
                                addDebugInfo(`åŠ è½½å›¾ç‰‡å¤±è´¥: ${file.name}`);
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        });
        
        // æ›´æ–°å¹¶å‘å¤„ç†æ•°
        concurrentProcesses.addEventListener('change', function() {
            maxConcurrent = parseInt(this.value);
            if (debugMode.value === 'on') {
                addDebugInfo(`è®¾ç½®æœ€å¤§å¹¶å‘æ•°: ${maxConcurrent}`);
            }
        });
        
        // è°ƒè¯•æ¨¡å¼åˆ‡æ¢
        debugMode.addEventListener('change', function() {
            debugContainer.style.display = this.value === 'on' ? 'block' : 'none';
            if (this.value === 'on' && uploadedImages.length > 0) {
                addDebugInfo(`å·²é€‰æ‹© ${uploadedImages.length} ä¸ªæ–‡ä»¶`);
            }
        });
        
        // æ‰¹é‡å¤„ç†å‡½æ•°
        async function batchProcess(mode) {
            if (uploadedImages.length === 0) return;
            
            encryptBtn.disabled = true;
            decryptBtn.disabled = true;
            downloadBtn.disabled = true;
            
            processedImages = [];
            const total = uploadedImages.length;
            let completed = 0;
            
            // æ›´æ–°è¿›åº¦æ¡
            progressFill.style.width = '0%';
            progressText.textContent = `0 / ${total} å·²å®Œæˆ`;
            
            // è·å–è´¨é‡è®¾ç½®
            const quality = parseFloat(qualitySetting.value);
            const debug = debugMode.value === 'on';
            
            if (debug) {
                addDebugInfo(`å¼€å§‹æ‰¹é‡å¤„ç†: æ¨¡å¼=${mode}, è´¨é‡=${quality}, å¹¶å‘æ•°=${maxConcurrent}`);
            }
            
            // å¤„ç†å‡½æ•°
            const processNextImage = async () => {
                if (completed >= total) return;
                
                // æ‰¾åˆ°ä¸‹ä¸€ä¸ªç­‰å¾…å¤„ç†çš„å›¾ç‰‡
                const nextIndex = uploadedImages.findIndex(img => img.status === 'waiting');
                if (nextIndex === -1) return;
                
                // æ ‡è®°ä¸ºå¤„ç†ä¸­
                uploadedImages[nextIndex].status = 'processing';
                const statusElement = document.querySelector(`.image-status[data-index="${nextIndex}"]`);
                statusElement.textContent = 'å¤„ç†ä¸­...';
                statusElement.style.color = '#4f1787';
                
                currentlyProcessing++;
                
                if (debug) {
                    addDebugInfo(`å¼€å§‹å¤„ç†: ${uploadedImages[nextIndex].name}`);
                }
                
                try {
                    const imageData = uploadedImages[nextIndex];
                    const processedUrl = await processImage(imageData.image, mode, quality, debug);
                    
                    processedImages.push({
                        index: nextIndex,
                        name: imageData.name,
                        originalUrl: imageData.originalUrl,
                        processedUrl: processedUrl
                    });
                    
                    // æ›´æ–°é¢„è§ˆ
                    document.querySelector(`.image-item:nth-child(${nextIndex + 1}) .image-preview`).src = processedUrl;
                    statusElement.textContent = mode === 'encrypt' ? 'å·²æ··æ·†' : 'å·²è§£æ··æ·†';
                    statusElement.style.color = '#2ecc71';
                    uploadedImages[nextIndex].status = 'completed';
                    
                    if (debug) {
                        addDebugInfo(`å¤„ç†å®Œæˆ: ${imageData.name}`);
                    }
                    
                } catch (error) {
                    statusElement.textContent = 'å¤„ç†å¤±è´¥';
                    statusElement.style.color = '#e74c3c';
                    console.error(`å¤„ç†å›¾ç‰‡ ${uploadedImages[nextIndex].name} æ—¶å‡ºé”™:`, error);
                    uploadedImages[nextIndex].status = 'failed';
                    
                    if (debug) {
                        addDebugInfo(`å¤„ç†å¤±è´¥: ${uploadedImages[nextIndex].name}, é”™è¯¯: ${error.message}`);
                    }
                }
                
                completed++;
                currentlyProcessing--;
                
                const progress = Math.round((completed / total) * 100);
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `${completed} / ${total} å·²å®Œæˆ`;
                
                // å¤„ç†ä¸‹ä¸€å¼ å›¾ç‰‡
                if (currentlyProcessing < maxConcurrent) {
                    processNextImage();
                }
                
                // å¦‚æœæ‰€æœ‰å›¾ç‰‡éƒ½å¤„ç†å®Œæˆï¼Œå¯ç”¨ä¸‹è½½æŒ‰é’®
                if (completed === total) {
                    downloadBtn.disabled = false;
                    if (debug) {
                        addDebugInfo(`æ‰¹é‡å¤„ç†å®Œæˆ: ${completed} / ${total}`);
                    }
                }
            };
            
            // å¯åŠ¨åˆå§‹å¤„ç†ä»»åŠ¡
            for (let i = 0; i < Math.min(maxConcurrent, total); i++) {
                processNextImage();
            }
        }
        
        // æŒ‰é’®äº‹ä»¶
        encryptBtn.addEventListener('click', () => batchProcess('encrypt'));
        decryptBtn.addEventListener('click', () => batchProcess('decrypt'));
        
        // ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
        downloadBtn.addEventListener('click', async function() {
            if (processedImages.length === 0) return;
            
            const debug = debugMode.value === 'on';
            
            if (debug) {
                addDebugInfo(`å¼€å§‹ä¸‹è½½ ${processedImages.length} å¼ å›¾ç‰‡`);
            }
            
            for (let i = 0; i < processedImages.length; i++) {
                const imageData = processedImages[i];
                
                try {
                    // è·å–Blobæ•°æ®
                    const response = await fetch(imageData.processedUrl);
                    const blob = await response.blob();
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `${mode === 'encrypt' ? 'encrypted_' : 'decrypted_'}${imageData.name.replace(/\.[^/.]+$/, "")}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // æ›´æ–°çŠ¶æ€
                    const statusElement = document.querySelector(`.image-status[data-index="${imageData.index}"]`);
                    statusElement.textContent = 'å·²ä¸‹è½½';
                    statusElement.style.color = '#3498db';
                    
                    if (debug) {
                        addDebugInfo(`å·²ä¸‹è½½: ${imageData.name}`);
                    }
                    
                } catch (error) {
                    console.error(`ä¸‹è½½å›¾ç‰‡ ${imageData.name} æ—¶å‡ºé”™:`, error);
                    const statusElement = document.querySelector(`.image-status[data-index="${imageData.index}"]`);
                    statusElement.textContent = 'ä¸‹è½½å¤±è´¥';
                    statusElement.style.color = '#e74c3c';
                    
                    if (debug) {
                        addDebugInfo(`ä¸‹è½½å¤±è´¥: ${imageData.name}, é”™è¯¯: ${error.message}`);
                    }
                }
                
                // æ·»åŠ ä¸€ç‚¹å»¶è¿Ÿï¼Œé¿å…åŒæ—¶å‘èµ·å¤ªå¤šä¸‹è½½è¯·æ±‚
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (debug) {
                addDebugInfo(`ä¸‹è½½å®Œæˆ`);
            }
        });
    </script>
</body>
</html>
